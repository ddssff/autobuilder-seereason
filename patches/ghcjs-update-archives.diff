--- old/Setup.hs	2014-07-08 07:38:57.781088293 -0700
+++ new/Setup.hs	2014-07-08 08:17:32.013152934 -0700
@@ -27,6 +27,7 @@
 
 ghcjsHooks :: UserHooks
 ghcjsHooks = simpleUserHooks { preSDist = ghcjsSDist
+                             , preBuild = \ a b -> updateArchives normal >> return emptyHookedBuildInfo
                              , postCopy = ghcjsPostCopy
                              }
 
@@ -37,9 +37,12 @@
  -}
 ghcjsSDist :: Args -> SDistFlags -> IO HookedBuildInfo
 ghcjsSDist as flags = do
-  rawSystemExit (fromFlagOrDefault normal $ sDistVerbosity flags) "bash" ["utils/update_archives.sh"]
+  updateArchives (fromFlagOrDefault normal $ sDistVerbosity flags)
   return emptyHookedBuildInfo
 
+updateArchives :: Verbosity -> IO ()
+updateArchives v = rawSystemExit v "bash" ["utils/update_archives.sh"]
+
 ghcjsPostCopy :: Args -> CopyFlags -> PackageDescription -> LocalBuildInfo -> IO ()
 ghcjsPostCopy args flags descr lbi
   | (FlagName "no-wrapper-install", True) `elem` configConfigurationsFlags (configFlags lbi) =

--- old/utils/update_archives.sh	2014-07-05 11:23:05.938224014 -0700
+++ new/utils/update_archives.sh	2014-07-05 11:30:31.590236462 -0700
@@ -105,12 +105,12 @@
 git update-index --assume-unchanged lib/cache/shims.tar
 git update-index --assume-unchanged lib/cache/test.tar
 
-STATUS=`git status --porcelain`
-if [ ${#STATUS} -gt 0 ]
-then
-    echo "working tree is dirty, run from a clean working tree"
-    exit 1
-fi
+# STATUS=`git status --porcelain`
+# if [ ${#STATUS} -gt 0 ]
+# then
+#     echo "working tree is dirty, run from a clean working tree"
+#     exit 1
+# fi
 
 if BRANCH=$(git symbolic-ref --short -q HEAD)
 then

